<!DOCTYPE html>
<html>

<head>
	<title>GA Calculator</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<meta name="theme-color" content="#007cba">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="ucal">
	<link rel="manifest" href="manifest.json">
	<style>
		body {
			font-family: sans-serif;
			padding: 20px;
			max-width: 1200px;
			margin: auto;
			position: relative;
			min-height: 100vh;
		}

		input,
		button {
			width: 100%;
			padding: 10px;
			margin: 10px 0;
			font-size: 16px;
		}

		/* Mobile viewport fix for keyboard */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}
			
			.average-result {
				position: sticky;
				top: 10px;
				z-index: 100;
				margin-bottom: 10px;
			}
			
			.tab-container {
				margin-bottom: 10px;
			}
			
			input {
				font-size: 16px; /* Prevents zoom on iOS */
			}
		}

		h2 {
			text-align: center;
		}

		pre {
			background: #f9f9f9;
			padding: 10px;
			white-space: pre-wrap;
		}

		.container {
			display: flex;
			flex-wrap: wrap;
			gap: 20px;
		}

		.form-section {
			flex: 1 1 300px;
		}

		.calendar-section {
			flex: 1 1 300px;
		}

		#pregnancy-wheel-container {
			position: relative;
			width: 400px;
			height: 400px;
			margin: auto;
		}

		#pregnancy-wheel {
			display: block;
		}

		/* Tab styles */
		.tab-container {
			margin-bottom: 20px;
		}

		.tab-buttons {
			display: flex;
			gap: 0;
			margin-bottom: 20px;
		}

		.tab-button {
			flex: 1;
			padding: 15px;
			background: #f0f0f0;
			border: 1px solid #ccc;
			cursor: pointer;
			transition: background-color 0.3s;
			margin: 0;
		}

		.tab-button.active {
			background: #007cba;
			color: white;
		}

		.tab-button:hover {
			background: #e0e0e0;
		}

		.tab-button.active:hover {
			background: #005a87;
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
		}

		/* Average calculator specific styles */
		.decimal-buttons {
			display: flex;
			gap: 10px;
			margin: 15px 0;
		}

		.decimal-button {
			flex: 1;
			padding: 8px;
			background: #f5f5f5;
			border: 1px solid #ccc;
			cursor: pointer;
			font-size: 14px;
			margin: 0;
		}

		.decimal-button.active {
			background: #28a745;
			color: white;
		}

		.average-inputs {
			margin: 20px 0;
		}

		.input-row {
			display: flex;
			align-items: center;
			margin: 10px 0;
			gap: 10px;
		}

		.input-row input {
			flex: 1;
			margin: 0;
		}

		.clear-input {
			background: #ffc107;
			color: #000;
			border: none;
			padding: 10px;
			cursor: pointer;
			width: auto;
			min-width: 60px;
			font-size: 12px;
		}

		.remove-input {
			background: #dc3545;
			color: white;
			border: none;
			padding: 10px;
			cursor: pointer;
			width: auto;
			min-width: 40px;
		}

		.average-result {
			font-size: 24px;
			font-weight: bold;
			text-align: center;
			padding: 20px;
			background: #e3f2fd;
			border-radius: 8px;
			margin: 20px 0;
		}

		.control-buttons {
			display: flex;
			gap: 10px;
			margin: 20px 0;
		}

		.add-input-btn {
			background: #28a745;
			color: white;
			flex: 1;
		}

		.clear-all-btn {
			background: #dc3545;
			color: white;
			flex: 1;
		}

		/* Settings tab styles */
		.setting-item {
			margin: 15px 0;
		}

		.setting-item label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
		}

		.setting-item select {
			width: 100%;
			padding: 8px;
			margin: 0;
		}

		.reset-settings-btn {
			background: #6c757d;
			color: white;
			margin-top: 20px;
		}

		.settings-info {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 5px;
			margin-top: 20px;
		}

		.settings-info p {
			margin: 0;
			font-size: 14px;
			color: #6c757d;
		}
	</style>


	<!-- Flatpickr CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

</head>

<body>
	<!-- Tab Navigation -->
	<div class="tab-container">
		<div class="tab-buttons">
			<button class="tab-button active" onclick="switchTab('ga-calculator')">GA Calculator</button>
			<button class="tab-button" onclick="switchTab('average-calculator')">Average Calculator</button>
			<button class="tab-button" onclick="switchTab('settings')">Settings</button>
		</div>
		
		<!-- GA Calculator Tab -->
		<div id="ga-calculator" class="tab-content active">
			<div class="container">
				<div class="form-section">
					<h2>4-Box GA Calculator with LMP, EDC</h2>

					<h3>LMP</h3>
					<input type="date" id="lmp" placeholder="LMP (optional)">

					<h3>EDC</h3>
					<input type="date" id="edc" placeholder="EDC (optional)">

					<button onclick="clearLmpEdc()">Clear LMP / EDC</button>

					<h3>Known Date / GA</h3>
					<input type="date" id="dateA" placeholder="Date A (known GA)">
					<input type="text" id="gaA" placeholder="GA on Date A (e.g. 10+3)">

					<h3>Calculated Date / GA</h3>
					<input type="date" id="dateB" placeholder="Date B (to find GA)">
					<input type="text" id="gaB" placeholder="GA on Date B (e.g. 12+0)">

					<button onclick="calculate()">Calculate</button>

					<pre id="output"></pre>
				</div>

				<div class="calendar-section">
					<h3>Calendar View</h3>
					<div id="calendar"></div>

					<h3>Pregnancy Wheel</h3>
					<div id="pregnancy-wheel-container">
						<svg id="pregnancy-wheel" width="400" height="400" viewBox="0 0 400 400">
							<!-- Outer circle -->
							<circle cx="200" cy="200" r="180" stroke="#333" stroke-width="2" fill="none"></circle>
							<!-- Inner circle (rotatable) -->
							<g id="inner-circle">
								<circle cx="200" cy="200" r="140" stroke="#666" stroke-width="2" fill="none"></circle>
							</g>
						</svg>
					</div>
				</div>
			</div>
		</div>

		<!-- Average Calculator Tab -->
		<div id="average-calculator" class="tab-content">
			<div class="container">
				<div class="form-section">
					<h2>Average Calculator</h2>
					
					<!-- Average display at the top -->
					<div id="average-result" class="average-result">
						Average: 0
					</div>
					
					<h3>Decimal Precision</h3>
					<div class="decimal-buttons">
						<button class="decimal-button" onclick="setDecimalPrecision(0)">0 decimal</button>
						<button class="decimal-button active" onclick="setDecimalPrecision(1)">1 decimal</button>
						<button class="decimal-button" onclick="setDecimalPrecision(2)">2+ decimal</button>
					</div>

					<div id="decimal-selector" style="display: none; margin: 10px 0;">
						<label for="decimal-count">Number of decimals: </label>
						<select id="decimal-count" onchange="updateDecimalPrecision()">
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
							<option value="5">5</option>
						</select>
					</div>

					<h3>Numbers</h3>
					<div class="control-buttons">
						<button class="add-input-btn" onclick="addInput()">Add More Box</button>
						<button class="clear-all-btn" onclick="clearAllInputs()">Clear All</button>
					</div>
					
					<div id="average-inputs" class="average-inputs">
						<!-- Dynamic inputs will be added here -->
					</div>
				</div>
			</div>
		</div>

		<!-- Settings Tab -->
		<div id="settings" class="tab-content">
			<div class="container">
				<div class="form-section">
					<h2>Settings</h2>
					
					<h3>Default Number of Input Boxes</h3>
					<div class="setting-item">
						<label for="default-boxes">Default boxes when opening Average Calculator:</label>
						<select id="default-boxes" onchange="saveSettings()">
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3" selected>3</option>
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>
							<option value="9">9</option>
							<option value="10">10</option>
						</select>
					</div>

					<h3>Default Decimal Precision</h3>
					<div class="setting-item">
						<label for="default-precision">Default precision:</label>
						<select id="default-precision" onchange="saveSettings()">
							<option value="0">0 decimal</option>
							<option value="1" selected>1 decimal</option>
							<option value="2">2 decimals</option>
							<option value="3">3 decimals</option>
							<option value="4">4 decimals</option>
							<option value="5">5 decimals</option>
						</select>
					</div>

					<h3>Default Starting Tab</h3>
					<div class="setting-item">
						<label for="default-tab">Tab to show when app opens:</label>
						<select id="default-tab" onchange="saveSettings()">
							<option value="ga-calculator" selected>GA Calculator</option>
							<option value="average-calculator">Average Calculator</option>
						</select>
					</div>

					<button onclick="resetSettings()" class="reset-settings-btn">Reset to Defaults</button>
					
					<div class="settings-info">
						<p><strong>Note:</strong> Settings are saved in your browser and will be remembered when you return to the calculator.</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="calculator.js"></script>

	<!-- Average Calculator JavaScript -->
	<script>
		let decimalPrecision = 1; // Default to 1 decimal
		let inputCount = 0;
		let defaultBoxCount = 3;

		// Settings management
		let defaultStartingTab = 'ga-calculator';

		function loadSettings() {
			const savedBoxCount = localStorage.getItem('ucal-default-boxes');
			const savedPrecision = localStorage.getItem('ucal-default-precision');
			const savedStartingTab = localStorage.getItem('ucal-default-tab');
			
			if (savedBoxCount) {
				defaultBoxCount = parseInt(savedBoxCount);
				document.getElementById('default-boxes').value = defaultBoxCount;
			}
			
			if (savedPrecision) {
				const precision = parseInt(savedPrecision);
				decimalPrecision = precision;
				document.getElementById('default-precision').value = precision;
				
				// Update UI to reflect saved precision
				updateDecimalPrecisionUI(precision);
			}

			if (savedStartingTab) {
				defaultStartingTab = savedStartingTab;
				document.getElementById('default-tab').value = defaultStartingTab;
				
				// Set the starting tab
				setInitialTab(defaultStartingTab);
			}
		}

		function saveSettings() {
			const boxCount = parseInt(document.getElementById('default-boxes').value);
			const precision = parseInt(document.getElementById('default-precision').value);
			const startingTab = document.getElementById('default-tab').value;
			
			localStorage.setItem('ucal-default-boxes', boxCount);
			localStorage.setItem('ucal-default-precision', precision);
			localStorage.setItem('ucal-default-tab', startingTab);
			
			defaultBoxCount = boxCount;
			decimalPrecision = precision;
			defaultStartingTab = startingTab;
			
			// Update average calculator if it's currently active
			const avgTab = document.getElementById('average-calculator');
			if (avgTab.classList.contains('active')) {
				updateDecimalPrecisionUI(precision);
				calculateAverage();
			}
		}

		function resetSettings() {
			localStorage.removeItem('ucal-default-boxes');
			localStorage.removeItem('ucal-default-precision');
			localStorage.removeItem('ucal-default-tab');
			
			defaultBoxCount = 3;
			decimalPrecision = 1;
			defaultStartingTab = 'ga-calculator';
			
			document.getElementById('default-boxes').value = defaultBoxCount;
			document.getElementById('default-precision').value = decimalPrecision;
			document.getElementById('default-tab').value = defaultStartingTab;
			
			updateDecimalPrecisionUI(1);
			calculateAverage();
			setInitialTab('ga-calculator');
		}

		function setInitialTab(tabId) {
			// Hide all tab contents
			document.querySelectorAll('.tab-content').forEach(content => {
				content.classList.remove('active');
			});
			
			// Remove active class from all buttons
			document.querySelectorAll('.tab-button').forEach(button => {
				button.classList.remove('active');
			});
			
			// Show selected tab
			document.getElementById(tabId).classList.add('active');
			
			// Add active class to corresponding button
			const buttons = document.querySelectorAll('.tab-button');
			if (tabId === 'ga-calculator') {
				buttons[0].classList.add('active');
			} else if (tabId === 'average-calculator') {
				buttons[1].classList.add('active');
			}
		}

		function updateDecimalPrecisionUI(precision) {
			// Update decimal buttons
			document.querySelectorAll('.decimal-button').forEach(btn => {
				btn.classList.remove('active');
			});
			
			const buttons = document.querySelectorAll('.decimal-button');
			if (precision === 0) {
				buttons[0].classList.add('active');
				document.getElementById('decimal-selector').style.display = 'none';
			} else if (precision === 1) {
				buttons[1].classList.add('active');
				document.getElementById('decimal-selector').style.display = 'none';
			} else {
				buttons[2].classList.add('active');
				document.getElementById('decimal-selector').style.display = 'block';
				document.getElementById('decimal-count').value = precision;
			}
		}

		// Tab switching functionality
		function switchTab(tabId) {
			// Hide all tab contents
			document.querySelectorAll('.tab-content').forEach(content => {
				content.classList.remove('active');
			});
			
			// Remove active class from all buttons
			document.querySelectorAll('.tab-button').forEach(button => {
				button.classList.remove('active');
			});
			
			// Show selected tab
			document.getElementById(tabId).classList.add('active');
			
			// Add active class to clicked button
			event.target.classList.add('active');
		}

		// Decimal precision functionality
		function setDecimalPrecision(precision) {
			// Update button states
			document.querySelectorAll('.decimal-button').forEach(btn => {
				btn.classList.remove('active');
			});
			event.target.classList.add('active');
			
			if (precision === 2) {
				// Show selector for 2+ decimals
				document.getElementById('decimal-selector').style.display = 'block';
				decimalPrecision = parseInt(document.getElementById('decimal-count').value);
			} else {
				// Hide selector and set precision
				document.getElementById('decimal-selector').style.display = 'none';
				decimalPrecision = precision;
			}
			
			updateAllInputBehavior();
			calculateAverage();
		}

		function updateDecimalPrecision() {
			decimalPrecision = parseInt(document.getElementById('decimal-count').value);
			updateAllInputBehavior();
			calculateAverage();
		}

		// Input management
		function createInputRow(index) {
			const row = document.createElement('div');
			row.className = 'input-row';
			row.dataset.index = index;
			
			const input = document.createElement('input');
			input.type = 'number';
			input.inputMode = 'decimal';
			input.step = 'any';
			input.placeholder = `Number ${index + 1}`;
			input.dataset.index = index;
			input.addEventListener('input', handleInput);
			input.addEventListener('keydown', handleKeydown);
			input.addEventListener('paste', handlePaste);
			input.addEventListener('focus', handleInputFocus);
			
			const clearBtn = document.createElement('button');
			clearBtn.textContent = 'Clear';
			clearBtn.className = 'clear-input';
			clearBtn.onclick = () => clearInput(index);
			
			const removeBtn = document.createElement('button');
			removeBtn.textContent = '×';
			removeBtn.className = 'remove-input';
			removeBtn.onclick = () => removeInput(index);
			
			row.appendChild(input);
			row.appendChild(clearBtn);
			
			// Only show remove button if more than default box count
			const currentInputCount = document.querySelectorAll('.input-row').length;
			if (currentInputCount >= defaultBoxCount) {
				row.appendChild(removeBtn);
			}
			
			return row;
		}

		function addInput() {
			const container = document.getElementById('average-inputs');
			const row = createInputRow(inputCount);
			container.appendChild(row);
			inputCount++;
			
			// Update remove button visibility
			updateRemoveButtons();
		}

		function removeInput(index) {
			const container = document.getElementById('average-inputs');
			const row = container.querySelector(`[data-index="${index}"]`);
			if (row) {
				row.remove();
				calculateAverage();
				updateRemoveButtons();
			}
		}

		function clearInput(index) {
			const input = document.querySelector(`input[data-index="${index}"]`);
			if (input) {
				input.value = '';
				input.focus();
				calculateAverage();
			}
		}

		function clearAllInputs() {
			const inputs = document.querySelectorAll('#average-inputs input');
			inputs.forEach(input => {
				input.value = '';
			});
			calculateAverage();
			
			// Focus on first input
			const firstInput = document.querySelector('#average-inputs input');
			if (firstInput) {
				firstInput.focus();
			}
		}

		function updateRemoveButtons() {
			const rows = document.querySelectorAll('.input-row');
			rows.forEach(row => {
				let removeBtn = row.querySelector('.remove-input');
				
				if (rows.length > defaultBoxCount) {
					if (!removeBtn) {
						removeBtn = document.createElement('button');
						removeBtn.textContent = '×';
						removeBtn.className = 'remove-input';
						removeBtn.onclick = () => removeInput(parseInt(row.dataset.index));
						row.appendChild(removeBtn);
					}
				} else {
					if (removeBtn) {
						removeBtn.remove();
					}
				}
			});
		}

		// Input behavior handling - removed automatic box addition
		function handleInput(event) {
			const input = event.target;
			const value = input.value;
			
			// Check if we need to jump to next input (but don't auto-create)
			if (decimalPrecision > 0) {
				const dotIndex = value.indexOf('.');
				if (dotIndex !== -1) {
					const afterDot = value.substring(dotIndex + 1);
					if (afterDot.length >= decimalPrecision) {
						const nextInput = getNextInput(input);
						if (nextInput) {
							nextInput.focus();
						}
					}
				}
			} else {
				// For 0 decimal precision, jump on any non-numeric input or when number is complete
				if (value && !value.includes('.') && isValidNumber(value)) {
					const nextInput = getNextInput(input);
					if (nextInput) {
						nextInput.focus();
					}
				}
			}
			
			calculateAverage();
		}

		function handleKeydown(event) {
			const input = event.target;
			
			// Handle backspace to previous input
			if (event.key === 'Backspace' && input.selectionStart === 0 && input.value === '') {
				const prevInput = getPreviousInput(input);
				if (prevInput) {
					prevInput.focus();
					prevInput.setSelectionRange(prevInput.value.length, prevInput.value.length);
				}
			}
		}

		function handlePaste(event) {
			event.preventDefault();
			const pastedData = (event.clipboardData || window.clipboardData).getData('text');
			const numbers = pastedData.split(/[\s,\n\t]+/).filter(s => s && isValidNumber(s));
			
			if (numbers.length > 0) {
				const currentInput = event.target;
				const startIndex = parseInt(currentInput.dataset.index);
				
				// Fill the inputs that exist
				numbers.forEach((num, i) => {
					const targetIndex = startIndex + i;
					const targetInput = document.querySelector(`input[data-index="${targetIndex}"]`);
					if (targetInput) {
						targetInput.value = num;
					}
				});
				
				calculateAverage();
			}
		}

		function getNextInput(currentInput) {
			const currentIndex = parseInt(currentInput.dataset.index);
			return document.querySelector(`input[data-index="${currentIndex + 1}"]`);
		}

		function getPreviousInput(currentInput) {
			const currentIndex = parseInt(currentInput.dataset.index);
			return document.querySelector(`input[data-index="${currentIndex - 1}"]`);
		}

		function updateAllInputBehavior() {
			// This function can be used to update input validation based on decimal precision
			calculateAverage();
		}

		function isValidNumber(str) {
			return !isNaN(parseFloat(str)) && isFinite(str);
		}

		// Mobile keyboard handling
		function handleInputFocus(event) {
			const input = event.target;
			// Removed auto-scroll - average stays at top position
		}

		// Calculate and display average
		function calculateAverage() {
			const inputs = document.querySelectorAll('#average-inputs input');
			const values = [];
			
			inputs.forEach(input => {
				const value = parseFloat(input.value);
				if (!isNaN(value)) {
					values.push(value);
				}
			});
			
			let average = 0;
			if (values.length > 0) {
				const sum = values.reduce((acc, val) => acc + val, 0);
				average = sum / values.length;
			}
			
			// Show the true value without rounding for display
			document.getElementById('average-result').textContent = `Average: ${average}`;
		}

		// Initialize average calculator when page loads
		document.addEventListener('DOMContentLoaded', function() {
			// Load settings first
			loadSettings();
			
			// Add initial inputs based on settings
			for (let i = 0; i < defaultBoxCount; i++) {
				addInput();
			}
		});
	</script>

	<!-- Flatpickr JS -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

	<script>
		// Date pickers for inputs
		// flatpickr("#lmp", { dateFormat: "Y-m-d" });
		// flatpickr("#edc", { dateFormat: "Y-m-d" });
		// flatpickr("#dateA", { dateFormat: "Y-m-d" });
		// flatpickr("#dateB", { dateFormat: "Y-m-d" });

		// Inline calendar view (read-only)
		flatpickr("#calendar", {
			inline: true,
			dateFormat: "Y-m-d",
			defaultDate: new Date(),
			disableMobile: true
		});
	</script>
	<script>
		const svg = document.getElementById("pregnancy-wheel");
		const innerCircleGroup = document.getElementById("inner-circle");
		const cx = 200,
			cy = 200;

		const daysInMonth = [31, 28, 31, 30, 31, 30,
			31, 31, 30, 31, 30, 31
		];
		const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
			"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
		];

		const totalDays = daysInMonth.reduce((a, b) => a + b, 0);






		// ✅ 1️⃣ Inner circle: weeks + week ticks
		for (let i = 0; i <= 40; i++) { // changed from 1..52 to 0..40
			const angle = (i * 7 / 365) * 2 * Math.PI - Math.PI / 2; // 7 days per week mapped to 365 days

			// Week number inside
			const rx = cx + 120 * Math.cos(angle);
			const ry = cy + 120 * Math.sin(angle);
			const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
			text.setAttribute("x", rx);
			text.setAttribute("y", ry);
			text.setAttribute("text-anchor", "middle");
			text.setAttribute("dominant-baseline", "middle");
			text.setAttribute("font-size", "10");
			text.textContent = i;

			// When creating each text, store its base angle:
			text.dataset.baseAngle = angle; // radians
			innerCircleGroup.appendChild(text);

			// Week tick mark
			// Longer tick for week 0 and week 40
			// ✅ Inner circle week ticks — longer for 0 & 40, and red color for those
			const weekTickLength = (i === 0 || i === 40) ? 30 : 5;
			const tickColor = (i === 0 || i === 40) ? "red" : "#666";

			const x1 = cx + 140 * Math.cos(angle);
			const y1 = cy + 140 * Math.sin(angle);
			const x2 = cx + (140 + weekTickLength) * Math.cos(angle);
			const y2 = cy + (140 + weekTickLength) * Math.sin(angle);

			const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
			line.setAttribute("x1", x1);
			line.setAttribute("y1", y1);
			line.setAttribute("x2", x2);
			line.setAttribute("y2", y2);
			line.setAttribute("stroke", tickColor);
			line.setAttribute("stroke-width", 1);
			innerCircleGroup.appendChild(line);
		}

		// ✅ 2️⃣ Outer circle: day ticks and day numbers
		let dayOffset = 0;
		let rawRotation = 0; // continuous, no snap
		let snappedRotation = 0; // the last snapped value

		daysInMonth.forEach((days, monthIndex) => {
			for (let d = 1; d <= days; d++) {
				const dayNumber = dayOffset + d;
				const angle = (dayNumber / totalDays) * 2 * Math.PI - Math.PI / 2;

				// Outer day tick: longer for multiples of 5, same width
				const tickLength = d % 5 === 0 ? 15 : 10; // 15px for 5s, 10px otherwise
				const x1 = cx + 145 * Math.cos(angle);
				const y1 = cy + 145 * Math.sin(angle);
				const x2 = cx + (145 + tickLength) * Math.cos(angle);
				const y2 = cy + (145 + tickLength) * Math.sin(angle);

				const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
				line.setAttribute("x1", x1);
				line.setAttribute("y1", y1);
				line.setAttribute("x2", x2);
				line.setAttribute("y2", y2);
				line.setAttribute("stroke", "#000");
				line.setAttribute("stroke-width", 1); // always thin
				svg.appendChild(line);

				// Day number every 5 days, placed a bit outside the tick
				if (d % 5 === 0) {
					const tx = cx + 165 * Math.cos(angle);
					const ty = cy + 165 * Math.sin(angle);
					const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
					text.setAttribute("x", tx);
					text.setAttribute("y", ty);
					text.setAttribute("text-anchor", "middle");
					text.setAttribute("dominant-baseline", "middle");
					text.setAttribute("font-size", "8");
					text.textContent = d;
					svg.appendChild(text);
				}
			}

			// ✅ Draw line between months
			const monthStartDay = dayOffset; // current offset before adding this month
			const angle = (monthStartDay / totalDays) * 2 * Math.PI - Math.PI / 2;

			const mx1 = cx + 155 * Math.cos(angle); // outer edge of day ticks
			const my1 = cy + 155 * Math.sin(angle);
			const mx2 = cx + 180 * Math.cos(angle); // reaches to the outer edge of month labels
			const my2 = cy + 180 * Math.sin(angle);

			const monthLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
			monthLine.setAttribute("x1", mx1);
			monthLine.setAttribute("y1", my1);
			monthLine.setAttribute("x2", mx2);
			monthLine.setAttribute("y2", my2);
			monthLine.setAttribute("stroke", "#333");
			monthLine.setAttribute("stroke-width", 2);
			svg.appendChild(monthLine);

			// ✅ Outer month names at the far rim
			const monthStart = dayOffset;
			const monthEnd = dayOffset + days;
			const midDay = (monthStart + monthEnd) / 2;
			const midAngle = (midDay / totalDays) * 2 * Math.PI - Math.PI / 2;
			const mx = cx + 180 * Math.cos(midAngle);
			const my = cy + 180 * Math.sin(midAngle);

			const monthText = document.createElementNS("http://www.w3.org/2000/svg", "text");
			monthText.setAttribute("x", mx);
			monthText.setAttribute("y", my);
			monthText.setAttribute("text-anchor", "middle");
			monthText.setAttribute("dominant-baseline", "middle");
			monthText.setAttribute("font-size", "10");
			monthText.textContent = monthNames[monthIndex];
			svg.appendChild(monthText);

			dayOffset += days;
		});
		let isDragging = false;
		let lastAngle = 0;

		// Mouse events
		svg.addEventListener("mousedown", startDrag);
		svg.addEventListener("mousemove", drag);
		svg.addEventListener("mouseup", endDrag);
		svg.addEventListener("mouseleave", endDrag);

		// Touch events
		svg.addEventListener("touchstart", startDragTouch, { passive: false });
		svg.addEventListener("touchmove", dragTouch, { passive: false });
		svg.addEventListener("touchend", endDrag);

		function getAngle(clientX, clientY) {
			const rect = svg.getBoundingClientRect();
			const x = clientX - rect.left - cx;
			const y = clientY - rect.top - cy;
			return Math.atan2(y, x);
		}

		function startDrag(event) {
			isDragging = true;
			lastAngle = getAngle(event.clientX, event.clientY);
		}

		function startDragTouch(event) {
			if (event.touches.length === 1) {
				isDragging = true;
				lastAngle = getAngle(event.touches[0].clientX, event.touches[0].clientY);
				event.preventDefault();
			}
		}

		function drag(event) {
			if (!isDragging) return;
			const angle = getAngle(event.clientX, event.clientY);
			const delta = angle - lastAngle;
			lastAngle = angle;
			rotateInner(delta);
		}

		function dragTouch(event) {
			if (!isDragging || event.touches.length !== 1) return;
			const angle = getAngle(event.touches[0].clientX, event.touches[0].clientY);
			const delta = angle - lastAngle;
			lastAngle = angle;
			rotateInner(delta);
			event.preventDefault();
		}

		function endDrag() {
			isDragging = false;
		}

		function rotateInner(delta) {
			const deltaDegrees = delta * 180 / Math.PI;
			rawRotation += deltaDegrees;

			const degreesPerWeek = (1 / 365) * 360;

			// Snap only when crossing threshold
			const newSnapped = Math.round(rawRotation / degreesPerWeek) * degreesPerWeek;

			// Only update if changed
			if (newSnapped !== snappedRotation) {
				snappedRotation = newSnapped;
				innerCircleGroup.setAttribute("transform", `rotate(${snappedRotation} ${cx} ${cy})`);

				// Keep labels upright
				const texts = innerCircleGroup.querySelectorAll("text");
				texts.forEach(text => {
					const baseAngle = parseFloat(text.dataset.baseAngle);
					const x = cx + 120 * Math.cos(baseAngle);
					const y = cy + 120 * Math.sin(baseAngle);
					text.setAttribute("x", x);
					text.setAttribute("y", y);
					text.setAttribute("transform", `rotate(${-snappedRotation} ${x} ${y})`);
				});
			}
		}

		if ('serviceWorker' in navigator) {
			window.addEventListener('load', function() {
				navigator.serviceWorker.register('/sw.js')
					.then(function(registration) {
						console.log('ServiceWorker registered: ', registration);
					}, function(err) {
						console.log('ServiceWorker registration failed: ', err);
					});
			});
		}
	</script>


</body>

</html>
